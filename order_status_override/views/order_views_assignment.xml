<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Enhanced Sale Order Form View with Workflow and Commission Fields -->
        <record id="view_order_form_enhanced_workflow" model="ir.ui.view">
            <field name="name">sale.order.form.enhanced.workflow</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Add unified workflow status bar with enhanced visibility -->
                <field name="state" position="before">
                    <field name="order_status" widget="statusbar" options="{'clickable': '1'}" readonly="state in ['sale', 'done', 'cancel']" class="o_enhanced_statusbar"/>
                    <field name="custom_status_id" invisible="1"/>
                    <!-- Enhanced computed fields for button visibility -->
                    <field name="show_document_review_button" invisible="1"/>
                    <field name="show_commission_calculation_button" invisible="1"/>
                    <field name="show_allocation_button" invisible="1"/>
                    <field name="show_final_review_button" invisible="1"/>
                    <field name="show_approve_button" invisible="1"/>
                    <field name="show_post_button" invisible="1"/>
                    <field name="show_reject_button" invisible="1"/>
                    <field name="auto_assigned_users" invisible="1"/>
                </field>

                <!-- Hide the default sales order status bar -->
                <field name="state" position="attributes">
                    <attribute name="invisible">1</attribute>
                </field>

                <!-- Add commission and workflow buttons in header with enhanced container -->
                <button name="action_quotation_send" position="after">
                    <div class="o_enhanced_button_section">
                        <button name="action_change_status" string="Change Status" type="object" class="btn-secondary o_enhanced_btn" icon="fa-exchange" invisible="1"/>
                        <button name="action_view_order_reports" string="Generate Reports" type="object" class="btn-info o_enhanced_btn" icon="fa-file-pdf-o"/>
                        <button name="%(order_status_override.report_sale_commission)d" string="Commission Report" type="action" class="btn-success o_enhanced_btn" icon="fa-money" invisible="state not in ['sale', 'done']"/>
                    </div>
                </button>

                <!-- Add enhanced unified workflow action buttons with improved spacing -->
                <button name="action_quotation_send" position="after">
                    <div class="o_workflow_buttons_container">
                        <!-- Draft to Document Review -->
                        <button name="action_move_to_document_review" string="Start Document Review" type="object" class="btn-primary o_workflow_btn" icon="fa-file-text-o" invisible="not show_document_review_button"/>

                        <!-- Document Review to Commission Calculation -->
                        <button name="action_move_to_commission_calculation" string="Start Commission Calculation" type="object" class="btn-info o_workflow_btn" icon="fa-calculator" invisible="not show_commission_calculation_button"/>

                        <!-- Commission Calculation to Allocation -->
                        <button name="action_move_to_allocation" string="Start Allocation" type="object" class="btn-warning o_workflow_btn" icon="fa-sitemap" invisible="not show_allocation_button"/>

                        <!-- Allocation to Final Review -->
                        <button name="action_move_to_final_review" string="Move to Final Review" type="object" class="btn-info o_workflow_btn" icon="fa-eye" invisible="not show_final_review_button"/>

                        <!-- Final Review to Approved -->
                        <button name="action_approve_order" string="Approve Order" type="object" class="btn-success o_workflow_btn" icon="fa-check" invisible="not show_approve_button"/>

                        <!-- Approved to Post -->
                        <button name="action_move_to_post" string="Post Order" type="object" class="btn-primary o_workflow_btn" icon="fa-paper-plane" invisible="not show_post_button"/>

                        <!-- Approved to Posted -->
                        <button name="action_post_order" string="Post Order" type="object" class="btn-success o_workflow_btn" icon="fa-paper-plane" invisible="not show_post_button"/>

                        <!-- Reject button (available in most stages) -->
                        <button name="action_reject_order" string="Reject Order" type="object" class="btn-danger o_workflow_btn" icon="fa-times" invisible="not show_reject_button"/>

                        <!-- Auto-reassign users button -->
                        <button name="action_reassign_workflow_users" string="Reassign Users" type="object" class="btn-secondary o_workflow_btn" icon="fa-users" help="Automatically reassign workflow users based on current group memberships"/>
                    </div>
                </button>

                <!-- Hide the default confirm/quotation buttons -->
                <button name="action_confirm" position="attributes">
                    <attribute name="invisible">1</attribute>
                </button>

                <!-- Add workflow assignment fields using xpath -->
                <xpath expr="//notebook" position="inside">
                    <page string="Workflow &amp; Assignment" name="workflow_assignment">
                        <group>
                            <group string="Enhanced Stage Assignments" name="stage_assignments">
                                <field name="documentation_user_id" options="{'no_create': True, 'no_quick_create': True}" help="User responsible for document review stage"/>
                                <field name="allocation_user_id" options="{'no_create': True, 'no_quick_create': True}" help="User responsible for allocation stage"/>
                                <field name="approval_user_id" options="{'no_create': True, 'no_quick_create': True}" help="User responsible for final approval"/>
                                <field name="posting_user_id" options="{'no_create': True, 'no_quick_create': True}" help="User responsible for posting approved orders"/>
                                <field name="auto_assigned_users" readonly="1" help="Indicates if users were automatically assigned based on groups"/>
                            </group>

                            <group string="Real Estate Details" name="real_estate_details">
                                <field name="booking_date"/>
                                <field name="project_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="unit_id" options="{'no_create': True, 'no_quick_create': True}" domain="[('type', '=', 'product')]"/>
                            </group>
                        </group>

                        <!-- Status History -->
                        <group string="Status History" name="status_history">
                            <field name="custom_status_history_ids" nolabel="1">
                                <tree editable="false" create="false" delete="false">
                                    <field name="status_id"/>
                                    <field name="create_date"/>
                                    <field name="create_uid"/>
                                    <field name="notes"/>
                                </tree>
                            </field>
                        </group>
                    </page>
                </xpath>

                <!-- Enhanced Commission Configuration using xpath -->
                <xpath expr="//notebook" position="inside">
                    <page string="Commission Configuration" name="commission_config">
                        <group>
                            <!-- External Commissions -->
                            <group string="External Commissions" name="external_commissions">
                                <separator string="Broker Commission" colspan="2"/>
                                <field name="broker_partner_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="broker_commission_type"/>
                                <field name="broker_rate"/>
                                <field name="broker_amount" readonly="1" widget="monetary"/>

                                <separator string="Referrer Commission" colspan="2"/>
                                <field name="referrer_partner_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="referrer_commission_type"/>
                                <field name="referrer_rate"/>
                                <field name="referrer_amount" readonly="1" widget="monetary"/>

                                <separator string="Cashback" colspan="2"/>
                                <field name="cashback_partner_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="cashback_commission_type"/>
                                <field name="cashback_rate"/>
                                <field name="cashback_amount" readonly="1" widget="monetary"/>
                            </group>

                            <!-- Internal Commissions -->
                            <group string="Internal Commissions" name="internal_commissions">
                                <separator string="Agent 1 Commission" colspan="2"/>
                                <field name="agent1_partner_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="agent1_commission_type"/>
                                <field name="agent1_rate"/>
                                <field name="agent1_amount" readonly="1" widget="monetary"/>

                                <separator string="Agent 2 Commission" colspan="2"/>
                                <field name="agent2_partner_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="agent2_commission_type"/>
                                <field name="agent2_rate"/>
                                <field name="agent2_amount" readonly="1" widget="monetary"/>

                                <separator string="Manager Commission" colspan="2"/>
                                <field name="manager_partner_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="manager_commission_type"/>
                                <field name="manager_rate"/>
                                <field name="manager_amount" readonly="1" widget="monetary"/>

                                <separator string="Director Commission" colspan="2"/>
                                <field name="director_partner_id" options="{'no_create': True, 'no_quick_create': True}"/>
                                <field name="director_commission_type"/>
                                <field name="director_rate"/>
                                <field name="director_amount" readonly="1" widget="monetary"/>
                            </group>
                        </group>

                        <!-- Commission Summary -->
                        <group string="Commission Summary" name="commission_summary">
                            <group>
                                <field name="total_external_commission_amount" readonly="1" widget="monetary"/>
                                <field name="total_internal_commission_amount" readonly="1" widget="monetary"/>
                            </group>
                            <group>
                                <field name="total_commission_amount" readonly="1" widget="monetary" style="font-weight: bold; font-size: 1.2em; color: #b19024;"/>
                            </group>
                        </group>
                    </page>
                </xpath>
            </field>
        </record>

        <!-- Enhanced Sale Order Tree View -->
        <record id="view_order_tree_enhanced_workflow" model="ir.ui.view">
            <field name="name">sale.order.tree.enhanced.workflow</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_tree"/>
            <field name="arch" type="xml">
                <field name="state" position="before">
                    <field name="order_status" optional="show"/>
                    <field name="custom_status_id" optional="hide"/>
                </field>
                <field name="amount_total" position="after">
                    <field name="booking_date" optional="show"/>
                    <field name="total_commission_amount" optional="hide" widget="monetary"/>
                </field>
            </field>
        </record>

        <!-- Enhanced Search View -->
        <record id="view_sales_order_filter_enhanced" model="ir.ui.view">
            <field name="name">sale.order.search.enhanced</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_sales_order_filter"/>
            <field name="arch" type="xml">
                <field name="name" position="after">
                    <field name="order_status"/>
                    <field name="booking_date"/>
                    <field name="custom_status_id"/>
                    <field name="documentation_user_id"/>
                    <field name="commission_user_id"/>
                    <field name="final_review_user_id"/>
                    <field name="posting_user_id"/>
                </field>
                <xpath expr="//search" position="inside">
                    <separator/>
                    <!-- Enhanced Unified Status Filters -->
                    <filter name="draft_status" string="Draft Orders" domain="[('order_status', '=', 'draft')]"/>
                    <filter name="document_review_status" string="Document Review" domain="[('order_status', '=', 'document_review')]"/>
                    <filter name="commission_calculation_status" string="Commission Calculation" domain="[('order_status', '=', 'commission_calculation')]"/>
                    <filter name="final_review_status" string="Final Review" domain="[('order_status', '=', 'final_review')]"/>
                    <filter name="approved_status" string="Approved Orders" domain="[('order_status', '=', 'approved')]"/>
                    <filter name="posted_status" string="Posted Orders" domain="[('order_status', '=', 'posted')]"/>

                    <!-- Enhanced Date Filters for Reports -->
                    <separator/>
                    <filter name="this_month_bookings" string="This Month Bookings" domain="[('booking_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d')), 
                                     ('booking_date', '&lt;', (context_today() + relativedelta(months=1, day=1)).strftime('%Y-%m-%d'))]"/>
                    <filter name="this_year_bookings" string="This Year Bookings" domain="[('booking_date', '&gt;=', (context_today() - relativedelta(month=1, day=1)).strftime('%Y-%m-%d')),
                                     ('booking_date', '&lt;', (context_today() + relativedelta(years=1, month=1, day=1)).strftime('%Y-%m-%d'))]"/>

                    <group string="Group By">
                        <filter name="group_by_order_status" string="Order Status" context="{'group_by': 'order_status'}"/>
                        <filter name="group_by_booking_date" string="Booking Date" context="{'group_by': 'booking_date:month'}"/>
                        <filter name="group_by_doc_user" string="Documentation User" context="{'group_by': 'documentation_user_id'}"/>
                        <filter name="group_by_commission_user" string="Commission User" context="{'group_by': 'commission_user_id'}"/>
                        <filter name="group_by_review_user" string="Review User" context="{'group_by': 'final_review_user_id'}"/>
                        <filter name="group_by_posting_user" string="Posting User" context="{'group_by': 'posting_user_id'}"/>
                    </group>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
