<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Sale Order Form View Enhancement with Commission Statement -->
        <record id="view_order_form_commission_statement" model="ir.ui.view">
            <field name="name">sale.order.form.commission.statement</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Add Commission Statement smart button -->
                <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                    <button name="action_view_commission_statement" type="object" class="oe_stat_button" icon="fa-file-text-o" groups="base.group_user,sales_team.group_sale_salesman"
                        modifiers="{'invisible': [['commission_statement_count', '=', 0]]}">
                        <div class="o_stat_info">
                            <field name="commission_statement_count" widget="statinfo" string="Commission Statement"/>
                        </div>
                    </button>
                </xpath>

                <!-- Add invisible fields for commission statement functionality -->
                <field name="amount_total" position="after">
                    <field name="commission_statement_count" modifiers="{'invisible': true}"/>
                </field>
            </field>
        </record>

        <!-- Enhanced Commission Management Tab -->
        <record id="view_order_form_commission_enhanced" model="ir.ui.view">
            <field name="name">sale.order.form.commission.enhanced</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="//notebook" position="inside">
                    <page string="Commission Management" name="commission_management">
                        <!-- Commission Status -->
                        <group name="commission_status_group">
                            <group string="Commission Status">
                                <field name="commission_status"/>
                                <field name="commission_processed"/>
                                <field name="commission_blocked_reason" modifiers="{'invisible': [['commission_blocked_reason', '=', False]]}"/>
                            </group>
                            <group string="Commission Totals">
                                <field name="total_commission_amount" widget="monetary"/>
                                <field name="total_external_commission_amount" widget="monetary"/>
                                <field name="total_internal_commission_amount" widget="monetary"/>
                                <field name="company_share" widget="monetary"/>
                                <field name="net_company_share" widget="monetary"/>
                            </group>
                        </group>

                        <!-- Legacy Commission Section -->
                        <group string="Legacy Commission Structure" name="legacy_commission">
                            <group string="Consultant">
                                <field name="consultant_id"/>
                                <field name="consultant_commission_type"/>
                                <field name="consultant_comm_percentage" modifiers="{'invisible': [['consultant_commission_type', '=', 'fixed']]}"/>
                                <field name="salesperson_commission" widget="monetary"/>
                            </group>
                            <group string="Management">
                                <field name="manager_id"/>
                                <field name="manager_legacy_commission_type"/>
                                <field name="manager_comm_percentage" modifiers="{'invisible': [['manager_legacy_commission_type', '=', 'fixed']]}"/>
                                <field name="manager_commission" widget="monetary"/>
                            </group>
                            <group string="Additional Agents">
                                <field name="second_agent_id"/>
                                <field name="second_agent_commission_type"/>
                                <field name="second_agent_comm_percentage" modifiers="{'invisible': [['second_agent_commission_type', '=', 'fixed']]}"/>
                                <field name="second_agent_commission" widget="monetary"/>
                            </group>
                            <group string="Director">
                                <field name="director_id"/>
                                <field name="director_legacy_commission_type"/>
                                <field name="director_comm_percentage" modifiers="{'invisible': [['director_legacy_commission_type', '=', 'fixed']]}"/>
                                <field name="director_commission" widget="monetary"/>
                            </group>
                        </group>

                        <!-- External Commission Section -->
                        <group string="External Commission Structure" name="external_commission">
                            <group string="Broker">
                                <field name="broker_partner_id"/>
                                <field name="broker_commission_type"/>
                                <field name="broker_rate" modifiers="{'invisible': [['broker_commission_type', '=', 'fixed']]}"/>
                                <field name="broker_amount" widget="monetary"/>
                            </group>
                            <group string="Referrer">
                                <field name="referrer_partner_id"/>
                                <field name="referrer_commission_type"/>
                                <field name="referrer_rate" modifiers="{'invisible': [['referrer_commission_type', '=', 'fixed']]}"/>
                                <field name="referrer_amount" widget="monetary"/>
                            </group>
                            <group string="Cashback">
                                <field name="cashback_partner_id"/>
                                <field name="cashback_commission_type"/>
                                <field name="cashback_rate" modifiers="{'invisible': [['cashback_commission_type', '=', 'fixed']]}"/>
                                <field name="cashback_amount" widget="monetary"/>
                            </group>
                            <group string="Other External">
                                <field name="other_external_partner_id"/>
                                <field name="other_external_commission_type"/>
                                <field name="other_external_rate" modifiers="{'invisible': [['other_external_commission_type', '=', 'fixed']]}"/>
                                <field name="other_external_amount" widget="monetary"/>
                            </group>
                        </group>

                        <!-- Internal Commission Section -->
                        <group string="Internal Commission Structure" name="internal_commission">
                            <group string="Agents">
                                <field name="agent1_partner_id"/>
                                <field name="agent1_commission_type"/>
                                <field name="agent1_rate" modifiers="{'invisible': [['agent1_commission_type', '=', 'fixed']]}"/>
                                <field name="agent1_amount" widget="monetary"/>
                            </group>
                            <group string="Agent 2">
                                <field name="agent2_partner_id"/>
                                <field name="agent2_commission_type"/>
                                <field name="agent2_rate" modifiers="{'invisible': [['agent2_commission_type', '=', 'fixed']]}"/>
                                <field name="agent2_amount" widget="monetary"/>
                            </group>
                            <group string="Manager">
                                <field name="manager_partner_id"/>
                                <field name="manager_commission_type"/>
                                <field name="manager_rate" modifiers="{'invisible': [['manager_commission_type', '=', 'fixed']]}"/>
                                <field name="manager_amount" widget="monetary"/>
                            </group>
                            <group string="Director">
                                <field name="director_partner_id"/>
                                <field name="director_commission_type"/>
                                <field name="director_rate" modifiers="{'invisible': [['director_commission_type', '=', 'fixed']]}"/>
                                <field name="director_amount" widget="monetary"/>
                            </group>
                        </group>

                        <!-- Commission Actions -->
                        <group string="Commission Actions" name="commission_actions">
                            <button name="action_process_commissions" string="Process Commissions" type="object" class="btn-primary"
                                modifiers="{'invisible': [['commission_processed', '=', true]]}"/>
                            <button name="action_confirm_commissions" string="Confirm Commissions" type="object" class="btn-success"
                                modifiers="{'invisible': [['commission_status', '!=', 'calculated'], ['commission_processed', '=', false]]}"/>
                            <button name="action_reset_commissions" string="Reset to Draft" type="object" class="btn-warning"
                                modifiers="{'invisible': [['commission_status', '=', 'draft']]}"/>
                        </group>

                        <!-- Purchase Orders -->
                        <group string="Related Purchase Orders" name="related_pos" modifiers="{'invisible': [['purchase_order_count', '=', 0]]}">
                            <field name="purchase_order_ids" nolabel="1">
                                <tree decoration-success="state == 'purchase'" decoration-info="state == 'draft'" decoration-muted="state == 'cancel'">
                                    <field name="name"/>
                                    <field name="partner_id"/>
                                    <field name="date_order"/>
                                    <field name="amount_total" widget="monetary"/>
                                    <field name="state"/>
                                    <field name="commission_posted"/>
                                    <button name="action_force_post" string="Force Post" type="object" icon="fa-check"
                                        modifiers="{'invisible': [['commission_posted', '=', true]]}"/>
                                </tree>
                            </field>
                        </group>
                    </page>
                </xpath>
            </field>
        </record>

        <!-- Sale Order Tree View Enhancement -->
        <record id="view_quotation_tree_commission" model="ir.ui.view">
            <field name="name">sale.order.tree.commission</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_tree"/>
            <field name="arch" type="xml">
                <field name="amount_total" position="after">
                    <field name="commission_status" optional="show"/>
                    <field name="commission_processed" optional="hide"/>
                    <field name="total_commission_amount" optional="hide" widget="monetary"/>
                </field>
            </field>
        </record>

        <!-- Sale Order Search View Enhancement -->
        <record id="view_sales_order_filter_commission" model="ir.ui.view">
            <field name="name">sale.order.search.commission</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_sales_order_filter"/>
            <field name="arch" type="xml">
                <filter name="my_sale_orders_filter" position="after">
                    <separator/>
                    <filter string="Commission Processed" name="commission_processed" domain="[('commission_processed', '=', True)]"/>
                    <filter string="Commission Pending" name="commission_pending" domain="[('commission_processed', '=', False), ('commission_status', '!=', 'draft')]"/>
                    <filter string="Commission Draft" name="commission_draft" domain="[('commission_status', '=', 'draft')]"/>
                </filter>
                <group expand="0" string="Group By" position="inside">
                    <filter string="Commission Status" name="group_commission_status" domain="[]" context="{'group_by': 'commission_status'}"/>
                </group>
            </field>
        </record>
    </data>
</odoo>