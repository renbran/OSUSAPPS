<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Sale Order Form View Enhancement -->
        <record id="view_order_form_inherit_commission_enhanced_v2" model="ir.ui.view">
            <field name="name">sale.order.form.inherit.commission.enhanced.v2</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Add commission buttons in header -->
                <xpath expr="//header" position="inside">
                    <button name="action_process_commissions" 
                            type="object" 
                            string="Calculate Commissions" 
                            class="btn-primary" 
                            invisible="commission_status != 'draft'"
                            help="Calculate and create commission purchase orders"
                            confirm="This will create purchase orders for all defined commissions. Continue?"/>
                    <button name="action_confirm_commissions" 
                            type="object" 
                            string="Confirm Commissions" 
                            class="btn-primary" 
                            invisible="commission_status != 'calculated'"
                            help="Confirm the calculated commissions"/>
                    <button name="action_reset_commissions" 
                            type="object" 
                            string="Reset to Draft" 
                            invisible="commission_status == 'draft'"
                            help="Reset commission status to draft"
                            confirm="This will cancel all related draft purchase orders. Continue?"/>
                    <button name="%(action_commission_report_wizard)d" 
                            type="action" 
                            string="Generate Report" 
                            class="btn-secondary"
                            help="Generate commission calculation report"/>
                </xpath>

                <!-- Add commission status field in header area -->
                <xpath expr="//field[@name='client_order_ref']" position="after">
                    <field name="commission_status" widget="statusbar" statusbar_visible="draft,calculated,confirmed"/>
                </xpath>

                <!-- Add invoice status indicators -->
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="is_fully_invoiced" invisible="1"/>
                    <field name="has_posted_invoices" invisible="1"/>
                    <field name="commission_blocked_reason" invisible="1"/>
                </xpath>

                <!-- Add warning banner for commission blocks -->
                <xpath expr="//sheet" position="before">
                    <div class="alert alert-warning" role="alert" 
                         invisible="not commission_blocked_reason">
                        <strong>Commission Processing Blocked:</strong>
                        <field name="commission_blocked_reason" readonly="1"/>
                    </div>
                </xpath>

                <!-- Add commission section as a new page in notebook -->
                <xpath expr="//notebook" position="inside">
                    <page string="Commissions" name="commissions">
                        <group>
                            <group string="Commission Summary">
                                <field name="total_external_commission_amount" readonly="1"/>
                                <field name="total_internal_commission_amount" readonly="1"/>
                                <field name="total_commission_amount" readonly="1"/>
                                <field name="company_share" readonly="1"/>
                                <field name="net_company_share" readonly="1"/>
                            </group>
                            <group string="Commission Controls">
                                <field name="commission_processed" readonly="1"/>
                                <field name="purchase_order_count" string="Generated POs"/>
                                <button name="%(action_view_commission_purchase_orders)d" 
                                        type="action" 
                                        string="View Purchase Orders"
                                        invisible="purchase_order_count == 0"
                                        context="{'search_default_origin_so_id': id}"/>
                                <field name="sales_value" readonly="1"/>
                            </group>
                        </group>

                        <!-- Invoice Status Indicators -->
                        <group string="Prerequisites" invisible="is_fully_invoiced and commission_status != 'draft'">
                            <div class="alert alert-info" role="alert" invisible="is_fully_invoiced">
                                <i class="fa fa-info-circle"/> Order must be fully invoiced before processing commissions.
                                <br/>Invoice Status: <field name="invoice_status" readonly="1"/>
                                <br/>Posted Invoices: <span invisible="has_posted_invoices">None</span><span invisible="not has_posted_invoices">Available</span>
                            </div>
                        </group>

                        <notebook>
                            <page string="External Commissions" name="external_commissions">
                                <group>
                                    <group string="Broker" name="broker_group">
                                        <field name="broker_partner_id"/>
                                        <field name="broker_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the broker commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="broker_rate"/>
                                        <field name="broker_amount" readonly="1" 
                                               invisible="not broker_commission_type"/>
                                    </group>
                                    <group string="Referrer" name="referrer_group">
                                        <field name="referrer_partner_id"/>
                                        <field name="referrer_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the referrer commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="referrer_rate"/>
                                        <field name="referrer_amount" readonly="1" 
                                               invisible="not referrer_commission_type"/>
                                    </group>
                                </group>
                                <group>
                                    <group string="Cashback" name="cashback_group">
                                        <field name="cashback_partner_id"/>
                                        <field name="cashback_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the cashback is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="cashback_rate"/>
                                        <field name="cashback_amount" readonly="1" 
                                               invisible="not cashback_commission_type"/>
                                    </group>
                                    <group string="Other External" name="other_external_group">
                                        <field name="other_external_partner_id"/>
                                        <field name="other_external_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the other external commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="other_external_rate"/>
                                        <field name="other_external_amount" readonly="1" 
                                               invisible="not other_external_commission_type"/>
                                    </group>
                                </group>
                            </page>

                            <page string="Internal Commissions" name="internal_commissions">
                                <group>
                                    <group string="Agent 1" name="agent1_group">
                                        <field name="agent1_partner_id"/>
                                        <field name="agent1_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how Agent 1 commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="agent1_rate"/>
                                        <field name="agent1_amount" readonly="1" 
                                               invisible="not agent1_commission_type"/>
                                    </group>
                                    <group string="Agent 2" name="agent2_group">
                                        <field name="agent2_partner_id"/>
                                        <field name="agent2_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how Agent 2 commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="agent2_rate"/>
                                        <field name="agent2_amount" readonly="1" 
                                               invisible="not agent2_commission_type"/>
                                    </group>
                                </group>
                                <group>
                                    <group string="Manager" name="manager_group">
                                        <field name="manager_partner_id"/>
                                        <field name="manager_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how Manager commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="manager_rate"/>
                                        <field name="manager_amount" readonly="1" 
                                               invisible="not manager_commission_type"/>
                                    </group>
                                    <group string="Director" name="director_group">
                                        <field name="director_partner_id"/>
                                        <field name="director_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how Director commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="director_rate"/>
                                        <field name="director_amount" readonly="1" 
                                               invisible="not director_commission_type"/>
                                    </group>
                                </group>
                            </page>

                            <page string="Legacy Commissions" name="legacy_commissions">
                                <group>
                                    <group string="Consultant" name="consultant_group">
                                        <field name="consultant_id"/>
                                        <field name="consultant_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the consultant commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="consultant_comm_percentage"/>
                                        <field name="salesperson_commission" readonly="1"/>
                                    </group>
                                    <group string="Manager (Legacy)" name="manager_legacy_group">
                                        <field name="manager_id"/>
                                        <field name="manager_legacy_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the manager commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="manager_comm_percentage"/>
                                        <field name="manager_commission" readonly="1"/>
                                    </group>
                                </group>
                                <group>
                                    <group string="Second Agent" name="second_agent_group">
                                        <field name="second_agent_id"/>
                                        <field name="second_agent_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the second agent commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="second_agent_comm_percentage"/>
                                        <field name="second_agent_commission" readonly="1"/>
                                    </group>
                                    <group string="Director (Legacy)" name="director_legacy_group">
                                        <field name="director_id"/>
                                        <field name="director_legacy_commission_type" widget="selection" 
                                               options="{'no_create': True}" 
                                               help="Select how the director commission is calculated: Fixed, Percentage of Unit Price, or Percentage of Untaxed Total."/>
                                        <field name="director_comm_percentage"/>
                                        <field name="director_commission" readonly="1"/>
                                    </group>
                                </group>
                                
                                <!-- Information note about legacy commissions -->
                                <div class="alert alert-info" role="alert">
                                    <h4><i class="fa fa-info-circle"/> Legacy Commission Types</h4>
                                    <p><strong>Fixed:</strong> Specific monetary amount (e.g., 1000 AED)</p>
                                    <p><strong>Percentage of Unit Price:</strong> Percentage based on product unit price</p>
                                    <p><strong>Percentage of Untaxed Total:</strong> Traditional percentage of order subtotal</p>
                                </div>
                            </page>
                        </notebook>
                    </page>
                </xpath>
            </field>
        </record>

        <!-- Purchase Order Commission View Action -->
        <record id="action_view_commission_purchase_orders" model="ir.actions.act_window">
            <field name="name">Commission Purchase Orders</field>
            <field name="res_model">purchase.order</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('origin_so_id', '=', active_id)]</field>
            <field name="context">{'search_default_origin_so_id': active_id}</field>
        </record>

        <!-- Commission Report Wizard Action -->
        <record id="action_commission_report_wizard" model="ir.actions.act_window">
            <field name="name">Generate Commission Report</field>
            <field name="res_model">commission.report.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="context">{'default_sale_order_id': active_id}</field>
        </record>

        <!-- Tree view to show commission status -->
        <record id="view_order_tree_inherit_commission" model="ir.ui.view">
            <field name="name">sale.order.tree.inherit.commission</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_tree"/>
            <field name="arch" type="xml">
                <field name="amount_total" position="after">
                    <field name="commission_status" string="Commission"/>
                    <field name="total_commission_amount" string="Total Commissions" sum="Total"/>
                    <field name="purchase_order_count" string="POs"/>
                </field>
            </field>
        </record>
    </data>
</odoo>