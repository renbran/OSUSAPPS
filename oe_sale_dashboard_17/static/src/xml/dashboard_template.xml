<?xml version="1.0" encoding="utf-8"?>
<templates>
    <t t-name="oe_sale_dashboard_17.yearly_sales_dashboard_template">
        <div class="o_oe_sale_dashboard_17_container">
            
            <!-- Loading Overlay -->
            <div t-if="state.isLoading" class="loading-overlay">
                <div class="loading-indicator">
                    <div class="spinner-ring"></div>
                    <div class="loading-text">Loading Dashboard...</div>
                </div>
            </div>

            <!-- Sample Data Warning -->
            <div t-if="state.showSampleDataWarning" class="alert alert-info alert-dismissible fade show">
                <strong>Sample Data Mode:</strong> 
                Using sample data for demonstration. No real sales data found.
                <button type="button" class="btn-close" t-on-click="closeSampleDataBanner"></button>
            </div>

            <!-- Error State -->
            <div t-if="state.hasError and !state.isLoading" class="error-container">
                <div class="error-message">
                    <h4>Dashboard Error</h4>
                    <p t-esc="state.errorMessage"></p>
                    <button type="button" class="btn btn-primary" t-on-click="refreshDashboard">
                        Retry
                    </button>
                </div>
            </div>

            <!-- Main Dashboard Content -->
            <div t-if="!state.hasError" class="dashboard-content">
                
                <!-- Header -->
                <div class="dashboard-header">
                    <div class="header-title">
                        <h1>Sales Dashboard</h1>
                        <p>Real-time sales performance and analytics</p>
                    </div>
                    
                    <div class="dashboard-controls">
                        <button type="button" class="btn btn-secondary" t-on-click="refreshDashboard">
                            <i class="fa fa-refresh"></i> Refresh
                        </button>
                        <button type="button" class="btn btn-info" t-on-click="testDataAvailability">
                            <i class="fa fa-database"></i> Test Data
                        </button>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Date Range</label>
                        <div class="date-inputs">
                            <input 
                                type="date" 
                                t-model="state.startDate" 
                                t-on-change="onStartDateChange"
                                class="form-control"/>
                            <span>to</span>
                            <input 
                                type="date" 
                                t-model="state.endDate" 
                                t-on-change="onEndDateChange"
                                class="form-control"/>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Quick Ranges</label>
                        <div class="quick-range-buttons">
                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                    t-on-click="() => this.setDateRange('7days')">
                                Last 7 Days
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                    t-on-click="() => this.setDateRange('30days')">
                                Last 30 Days
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                    t-on-click="() => this.setDateRange('90days')">
                                Last 90 Days
                            </button>
                        </div>
                    </div>
                </div>

                <!-- KPI Section -->
                <div class="kpi-section">
                    <div class="kpi-row">
                        <!-- Total Quotations -->
                        <div class="kpi-card warning">
                            <div class="kpi-icon">ðŸ“‹</div>
                            <div class="kpi-content">
                                <div class="kpi-label">Total Quotations</div>
                                <div class="kpi-value" t-esc="state.summaryData.totalQuotations.formatted"></div>
                                <div class="kpi-subtext" t-esc="state.summaryData.totalQuotations.count + ' quotes'"></div>
                            </div>
                        </div>

                        <!-- Sales Orders -->
                        <div class="kpi-card info">
                            <div class="kpi-icon">ðŸ“Š</div>
                            <div class="kpi-content">
                                <div class="kpi-label">Sales Orders</div>
                                <div class="kpi-value" t-esc="state.summaryData.totalSalesOrders.formatted"></div>
                                <div class="kpi-subtext" t-esc="state.summaryData.totalSalesOrders.count + ' orders'"></div>
                            </div>
                        </div>

                        <!-- Invoiced Sales -->
                        <div class="kpi-card success">
                            <div class="kpi-icon">ðŸ’°</div>
                            <div class="kpi-content">
                                <div class="kpi-label">Invoiced Sales</div>
                                <div class="kpi-value" t-esc="state.summaryData.totalInvoiced.formatted"></div>
                                <div class="kpi-subtext" t-esc="state.summaryData.totalInvoiced.count + ' invoiced'"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary KPIs -->
                    <div class="kpi-row secondary">
                        <div class="kpi-card primary outline">
                            <div class="kpi-icon">ðŸŽ¯</div>
                            <div class="kpi-content">
                                <div class="kpi-label">Conversion Rate</div>
                                <div class="kpi-value" t-esc="state.summaryData.conversionRate"></div>
                            </div>
                        </div>

                        <div class="kpi-card primary outline">
                            <div class="kpi-icon">ðŸ’Ž</div>
                            <div class="kpi-content">
                                <div class="kpi-label">Average Deal Size</div>
                                <div class="kpi-value" t-esc="state.summaryData.avgDealSize"></div>
                            </div>
                        </div>

                        <div class="kpi-card primary outline">
                            <div class="kpi-icon">ðŸ“ˆ</div>
                            <div class="kpi-content">
                                <div class="kpi-label">Revenue Growth</div>
                                <div class="kpi-value" t-esc="state.summaryData.revenueGrowth"></div>
                            </div>
                        </div>

                        <div class="kpi-card primary outline">
                            <div class="kpi-icon">âš¡</div>
                            <div class="kpi-content">
                                <div class="kpi-label">Pipeline Velocity</div>
                                <div class="kpi-value" t-esc="state.summaryData.pipelineVelocity"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    
                    <!-- Full-width Sales Trends Chart -->
                    <div class="chart-container full-width">
                        <div class="chart-header">
                            <h3 class="chart-title">Sales Trends Over Time</h3>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="trendsLineChart"></canvas>
                        </div>
                    </div>

                    <!-- Two-column chart layout -->
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Revenue by Category</h3>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="enhancedPieChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Orders by Status</h3>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="comparisonBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Overview -->
                <div class="categories-section" t-if="state.categoryNames.length > 0">
                    <h2 class="section-title">Sales Performance by Category</h2>
                    
                    <div class="category-grid">
                        <t t-foreach="state.categoryNames" t-as="categoryName" t-key="categoryName">
                            <t t-set="categoryData" t-value="state.categoriesData[categoryName]"/>
                            <div class="category-card">
                                <div class="category-header">
                                    <h4 t-esc="categoryName"/>
                                    <div class="category-total" t-esc="categoryData.formatted_total_amount"/>
                                </div>
                                
                                <div class="category-breakdown">
                                    <div class="breakdown-item">
                                        <div class="breakdown-dot draft"></div>
                                        <div class="breakdown-label">Quotations</div>
                                        <div class="breakdown-count" t-esc="categoryData.draft_count"/>
                                        <div class="breakdown-amount" t-esc="categoryData.formatted_draft_amount"/>
                                    </div>
                                    
                                    <div class="breakdown-item">
                                        <div class="breakdown-dot sales"></div>
                                        <div class="breakdown-label">Sales Orders</div>
                                        <div class="breakdown-count" t-esc="categoryData.sales_order_count"/>
                                        <div class="breakdown-amount" t-esc="categoryData.formatted_sales_order_amount"/>
                                    </div>
                                    
                                    <div class="breakdown-item">
                                        <div class="breakdown-dot invoice"></div>
                                        <div class="breakdown-label">Invoiced</div>
                                        <div class="breakdown-count" t-esc="categoryData.invoice_count"/>
                                        <div class="breakdown-amount" t-esc="categoryData.formatted_invoice_amount"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>

                <!-- Recent Orders Table -->
                <div t-if="state.recentOrders.length > 0" class="table-container">
                    <h3 class="table-title">Recent Orders</h3>
                    
                    <div class="table-wrapper">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Order Number</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="state.recentOrders" t-as="order" t-key="order.id">
                                    <tr>
                                        <td t-esc="order.name"/>
                                        <td t-esc="order.partner_name"/>
                                        <td t-esc="order.date"/>
                                        <td t-esc="order.amount_formatted"/>
                                        <td>
                                            <span t-att-class="'badge ' + order.status_class" 
                                                  t-esc="order.status_text"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Agents Table -->
                <div t-if="state.topAgentsData.length > 0" class="table-container">
                    <h3 class="table-title">Top Sales Agents</h3>
                    
                    <div class="table-wrapper">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Agent Name</th>
                                    <th>Sales Count</th>
                                    <th>Total Sales Value</th>
                                    <th>Total Commission</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="state.topAgentsData" t-as="agent" t-key="agent.partner_id">
                                    <tr>
                                        <td class="rank-cell">
                                            <div class="rank-number" t-esc="agent_index + 1"/>
                                        </td>
                                        <td t-esc="agent.partner_name"/>
                                        <td t-esc="agent.count"/>
                                        <td t-esc="formatDashboardValue(agent.total_sales_value)"/>
                                        <td t-esc="formatDashboardValue(agent.total_commission)"/>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- No Data State -->
                <div t-if="state.recentOrders.length === 0 and state.topAgentsData.length === 0 and state.categoryNames.length === 0" 
                     class="no-data">
                    <div class="no-data-icon">ðŸ“Š</div>
                    <h3>No Data Available</h3>
                    <p>No sales data found for the selected date range.</p>
                    <div class="no-data-actions">
                        <button type="button" class="btn btn-primary" t-on-click="() => this.setDateRange('90days')">
                            Try Last 90 Days
                        </button>
                        <button type="button" class="btn btn-outline-secondary" t-on-click="refreshDashboard">
                            Refresh Data
                        </button>
                    </div>
                </div>

                <!-- Dashboard Footer -->
                <div class="dashboard-footer">
                    <div class="footer-content">
                        <div class="footer-item">
                            <i class="fa fa-database"></i>
                            <span>Data Source: Sales Orders</span>
                        </div>
                        
                        <div class="footer-item">
                            <i class="fa fa-calendar"></i>
                            <span>Period: <t t-esc="state.startDate"/> to <t t-esc="state.endDate"/></span>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </t>
</templates>